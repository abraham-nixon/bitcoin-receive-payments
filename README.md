bitcoin-receive-payments
===================
Allow your service to receive bitcoin payments directly from the bitcoin P2P network.

Payment notifications are received **live**, directly from the bitcoin network.

An unique bitcoin address is used for each payment, and all funds go to the same wallet, using a [Deterministic Wallet](https://en.bitcoin.it/wiki/Deterministic_wallet) public key. 

Motivation
--
This module eliminates the need of a [payment API](https://blockchain.info/es/api/api_receive) like the one provided by [blockchain.info](https://blockchain.info/) making bitcoin payments even more private and secure.

Bitcoin is designed to remove intermediaries, this module intends exactly that.

Security
--

No private key is stored in the server, so **funds cannot be used even if the server get's hacked**.

Backend
--
This modules uses the [insight-api](https://github.com/bitpay/insight-api) that is already running on many reliable servers online.

Install
--------------------

> npm install bitcoin-receive-payments --save

Use
---
Initialize the payment gateway directly in your nodejs app:
```
var gateway = new BitcoinGateway(pub_key, openexchangerates_key)
```
**pub_key** is a [extended public key (xPub)](https://bitcoin.org/en/glossary/extended-key) 
**openexchangerates_key** is a API key from [openexchangerates.org](https://openexchangerates.org/)


Obtaining an Extended Public Key (xPub) 
----
xPubs can be created with your bitcoin wallet if it supports [BIT32](https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki) you can also [create one online](http://bip32.org/) but I wouldn't recommend it.

I do recommend visiting [http://bip32.org/](http://bip32.org/) to better understand how Deterministic Wallets work.

The **bitpay** wallet (desktop version) automatically creates it for you, you can find it in **Settings -> Personal Wallet -> More Options -> Wallet Information -> Copayer 0**

Use
--

Every time you want to allow the user to make a bitcoin payment, all you need is an unique_ID for that user in your database, and use that ID to create an ***unique address*** for him, for example this script:

```javascript
  var unique_ID = 5554555 // get this from your database

  gateway.createAddress(unique_ID)
    .then(function(address) {
    
      console.log('got new address', address.address, ' and it has', address.seconds_left / 60, 'minutes left.')
      
      var amount = 3.99
      
      console.log('will ask user ', amount, 'USD in it as', gateway.USDtoBIT(amount) + ' bits, using HTML, preferably as a QR code')
      
    }).catch(function() {
      console.log('limit reached! cant get a new address :(')
    })
```
Would output:
> created new address 1K2xWPtGsvg5Sa2X7URZ5VfU8xS62McbXz  and it has 14.992800001303355 minutes left.
> ask user  3.99 USD (3763.63610805 bits) using HTML (3763.63610805 bits), preferably as a QR code

All payments sent to your wallet will trigger a **payment** event that must be handled as follows:
```javascript
gateway.events.on('payment', function(payment) {
  console.log('got a payment on one of our addresses!.', payment)
})
```

The **payment** event will also be triggered at **initialization** if there are payments that happened when the server was reloading/restarting or just turned off. So make sure to handle the payment event, before starting the gateway with:

```javascript
gateway.connect()
```

The **initialized** event means that the gateway is ready and monitoring the bitcoin network so to detect any payment made to any of the newly created addresses generated by the gateway. 

```javascript
gateway.events.on('initialized', function() {
  console.log('gateway has been intialized.')
  // start creating addresses after the initialized event
  // gateway.createAddress(unique_id)...
});
```

So that if someone makes a payment to that address, you will receive a notification it in matter of 2 or 3 seconds:
>got a payment on one of our addresses!. 
>{ address: '1K2xWPtGsvg5Sa2X7URZ5VfU8xS62McbXz',
  amount: 380600,
  **id: '5554555'**,
  usd_amount: **4.034911868211425** }

With this information you can perfectly know that the user with the **unique_id 5554555** is the one who made the payment of the **$4** and process it accordingly.

Address expiration time
--

All newly created addresses have countdown of 15 minutes, it is a consequence of a limitation imposed by [BIP0044](https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki) specification.

When recovering a [Deterministic Wallet](https://en.bitcoin.it/wiki/Deterministic_wallet) all child addresses are recreated to recover all the funds on each one of them, if 20 consecutive child addresses are checked and no funds are found, it finishes recovering and no more are checked, assuming there is no more funds in any more child-addresses.

This module automatically makes sure to reuse addresses that haven't received a payment. Giving them a time expiration (15min) for each customer/user to use them, or get a new one, after which, the address can be reused or reassigned.

All this, ensures that no child addresses are created if existing ones haven't been used, defining a maximum of 15 simultaneous unused addresses, all this is handled automatically by this module.

The number of minutes can be modified towards improving user experience, only keep in mind that the objective is to ensure that no addresses are left unused.